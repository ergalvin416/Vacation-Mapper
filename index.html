<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Vacation Mapper V71.3</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC78EKBgSd2UsLSPUTGO1A-MF78BU20aLg&libraries=places"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root { --bg:#1e1e24; --panel:#16161c; --accent:#4a90e2; --text:#eee; --danger:#e74c3c; --todo:#e74c3c; --stay:#27ae60; --eat:#f1c40f; }
        body { margin:0; display:flex; height:100vh; font-family:-apple-system,sans-serif; background:#121212; color:var(--text); overflow:hidden; }
        #container { display:flex; width:100%; height:100%; flex-direction: row; }
        #sidebar { width:350px; background:var(--bg); border-right:1px solid #333; display:flex; flex-direction:column; overflow-y:auto; z-index: 10; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #map { flex:1; position: relative; }
        
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #map { height: 100vh; width: 100%; position: absolute; top:0; left:0; }
            #sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 80vh; border-right: none; border-top: 1px solid #444; border-radius: 20px 20px 0 0; transform: translateY(calc(80vh - 70px)); box-shadow: 0 -5px 25px rgba(0,0,0,0.6); touch-action: pan-y; }
            #sidebar.expanded { transform: translateY(0); }
            .mobile-handle { display: flex !important; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 70px; background: #2a2a32; cursor: pointer; border-radius: 20px 20px 0 0; flex-shrink: 0; position: sticky; top: 0; z-index: 15; }
            .handle-bar { width: 45px; height: 6px; background: #555; border-radius: 10px; margin-bottom: 5px; }
            .handle-text { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; }
        }

        .mobile-handle { display: none; }
        .section { padding:15px; border-bottom:1px solid #333; }
        .search-container { position: relative; width: 100%; }
        #search-box { width: 100%; padding: 12px; padding-right: 40px !important; background:#121212; color:white; border:1px solid #444; border-radius:6px; box-sizing:border-box; font-size: 16px; }
        #clear-search-btn { position: absolute; right: 10px; top: 12px; background: #333; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 14px; z-index: 5; }
        
        .vacation-item { padding:12px; background:#2a2a32; margin-bottom:8px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items: center; border-left: 6px solid transparent; }
        .active-trip { border-left: 6px solid var(--accent); background:#3a3a45; }
        
        /* FIX: Layout for notes and buttons */
        .saved-place { padding:12px 0; border-bottom:1px solid #222; }
        .place-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .place-info { flex: 1; min-width: 0; }
        .place-info b { display:block; font-size: 1.05em; cursor: pointer; word-wrap: break-word; margin-bottom: 4px; }
        
        /* NEW: Expandable note text */
        .note-preview { font-size: 12px; color: #aaa; font-style: italic; line-height: 1.4; word-wrap: break-word; cursor: pointer; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; transition: max-height 0.3s ease; }
        .note-preview.expanded { display: block; -webkit-line-clamp: initial; overflow: visible; color: #fff; }
        
        .button-group { display: flex; gap: 8px; flex-shrink: 0; }
        .name-todo { color: var(--todo) !important; }
        .name-stay { color: var(--stay) !important; }
        .name-eat { color: var(--eat) !important; }
        
        .pin-links { display:flex; flex-wrap: wrap; gap:6px; margin-top:10px; }
        .pin-links a { color:var(--accent); text-decoration:none; font-size:0.65em; font-weight:bold; text-transform:uppercase; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; }
        .category-header { font-size:10px; text-transform:uppercase; color:#888; margin-top:12px; font-weight:bold; border-bottom: 1px dotted #444; padding-bottom: 4px; }
        .form-overlay { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#25252b; padding:20px; border-radius:12px; z-index:999; width:85%; max-width:350px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        input, textarea, select { width:100%; margin-bottom:10px; background:#121212; color:white; border:1px solid #444; padding:12px; border-radius:6px; box-sizing:border-box; font-size: 16px; }
        button.primary { width:100%; padding:12px; background:var(--accent); border:none; color:white; font-weight:bold; cursor:pointer; border-radius:6px; }
        .icon-btn { background:none; border:none; color:#777; cursor:pointer; font-size:1.2em; padding:4px; display: flex; align-items: center; justify-content: center; }
        .gps-btn { position: absolute; bottom: 90px; right: 20px; background: white; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.4); z-index: 5; cursor: pointer; font-size: 20px; }
        .popup-links { display: flex; gap: 10px; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px; }
        .popup-links a { font-size: 10px; font-weight: bold; color: var(--accent); text-decoration: none; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="container">
    <div id="sidebar">
        <div class="mobile-handle" id="sheetHandle"><div class="handle-bar"></div><div class="handle-text">Swipe or Tap to View Pins</div></div>
        <div class="section">
            <h3 style="margin-top:0;">üåç SHARED VACATIONS</h3>
            <input id="tripName" placeholder="NEW TRIP NAME..." />
            <button class="primary" onclick="TripManager.addTrip()">CREATE FOLDER</button>
            <div id="tripList" style="margin-top:10px"></div>
        </div>
        <div class="section">
            <div class="search-container">
                <input id="search-box" placeholder="üîç SEARCH PLACES..." />
                <button id="clear-search-btn" onclick="SearchModule.clearFullSearch()">‚úï</button>
            </div>
        </div>
        <div class="section" id="place-details">
            <h4 id="activeTripTitle" style="color:var(--accent); margin-top:0;">SAVED PINS</h4>
            <div id="groupedList"></div>
        </div>
    </div>
    <div id="map"><div class="gps-btn" onclick="UIManager.locateMe()">üìç</div></div>
</div>

<div id="pinModal" class="form-overlay">
    <h3 id="modalTitle">ADD PIN</h3>
    <input id="pName" placeholder="NAME" />
    <input id="pAddress" placeholder="ADDRESS" />
    <input id="pPhone" placeholder="PHONE NUMBER" />
    <input id="pLink" placeholder="WEBSITE URL" />
    <input id="pgUrl" type="hidden" />
    <input id="pyUrl" type="hidden" />
    <textarea id="pNotes" placeholder="NOTES..."></textarea>
    <select id="pType">
        <option value="üî¥ Things to Do">üî¥ Things to Do</option>
        <option value="üü¢ Places to Stay">üü¢ Places to Stay</option>
        <option value="üü° Places to Eat">üü° Places to Eat</option>
    </select>
    <button class="primary" onclick="TripManager.savePin()">SAVE PIN</button>
    <button onclick="UIManager.closeModal()" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
</div>

<script>
const AppState = {
    map: null, service: null, infoWindow: null, autocomplete: null,
    trips: {}, activeTrip: null, markers: [], searchMarkers: [],
    pendingCoords: null, editingPinId: null, touchStartY: 0, touchEndY: 0,
    placeCache: {}
};

const firebaseConfig = {
    apiKey: "AIzaSyAlflCNqAaVmui0ipNCCWs3XNsvjprlFYA",
    authDomain: "vacation-mapper-1e723.firebaseapp.com",
    databaseURL: "https://vacation-mapper-1e723-default-rtdb.firebaseio.com",
    projectId: "vacation-mapper-1e723",
    storageBucket: "vacation-mapper-1e723.firebasestorage.app",
    messagingSenderId: "773407322730",
    appId: "1:773407322730:web:9b27eb7ee5c3ebac2cd013"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const UIManager = {
    initGestures() {
        const handle = document.getElementById('sheetHandle');
        const sidebar = document.getElementById('sidebar');
        handle.addEventListener('click', () => this.setSheetState(!sidebar.classList.contains('expanded')));
        sidebar.addEventListener('touchstart', (e) => { AppState.touchStartY = e.touches[0].screenY; }, {passive: true});
        sidebar.addEventListener('touchend', (e) => {
            AppState.touchEndY = e.changedTouches[0].screenY;
            const diff = AppState.touchStartY - AppState.touchEndY;
            if (Math.abs(diff) > 50) { if (diff > 0) this.setSheetState(true); else this.setSheetState(false); }
        }, {passive: true});
    },
    setSheetState(isExpanded) {
        if (window.innerWidth > 768) return;
        const sidebar = document.getElementById('sidebar');
        if (isExpanded) sidebar.classList.add('expanded');
        else { sidebar.classList.remove('expanded'); sidebar.scrollTop = 0; }
    },
    openModal(lat, lng, name = '', address = '', id = '', website = '', phone = '', gUrl = '', yUrl = '') {
        if (!AppState.activeTrip) return alert('Select folder!');
        AppState.pendingCoords = { lat, lng }; AppState.editingPinId = id;
        document.getElementById('pName').value = name; document.getElementById('pAddress').value = address;
        document.getElementById('pPhone').value = phone; document.getElementById('pLink').value = website;
        document.getElementById('pgUrl').value = gUrl; document.getElementById('pyUrl').value = yUrl;
        if (!id) { document.getElementById('pNotes').value = ''; document.getElementById('pType').value = 'üî¥ Things to Do'; }
        document.getElementById('modalTitle').innerText = id ? "EDIT PIN" : "ADD PIN";
        document.getElementById('pinModal').style.display = 'block';
    },
    closeModal() { document.getElementById('pinModal').style.display = 'none'; },
    locateMe() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                AppState.map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                AppState.map.setZoom(17); this.setSheetState(false);
            });
        }
    },
    toggleNote(el) { el.classList.toggle('expanded'); } // NEW
};

const TripManager = {
    addTrip() {
        const input = document.getElementById('tripName');
        const n = input.value.trim(); if (!n) return;
        const safeKey = n.replace(/[.#$/\[\]]/g, '_');
        db.ref(`trips/${safeKey}`).set({ created: Date.now(), name: n, pins: {} }).then(() => { input.value = ''; });
    },
    savePin() {
        if (!AppState.activeTrip) return alert("Select folder!");
        const pinId = AppState.editingPinId || Date.now();
        const pinData = { 
            id: pinId, lat: AppState.pendingCoords.lat, lng: AppState.pendingCoords.lng, 
            name: document.getElementById('pName').value, address: document.getElementById('pAddress').value, 
            phone: document.getElementById('pPhone').value, link: document.getElementById('pLink').value, 
            gUrl: document.getElementById('pgUrl').value, yUrl: document.getElementById('pyUrl').value, 
            notes: document.getElementById('pNotes').value, type: document.getElementById('pType').value 
        };
        db.ref(`trips/${AppState.activeTrip}/pins/${pinId}`).set(pinData).then(() => { SearchModule.clearFullSearch(); UIManager.closeModal(); });
    },
    deleteTrip(key) {
        if (confirm("Delete Trip?")) db.ref(`trips/${key}`).remove();
    },
    deletePin(id) {
        db.ref(`trips/${AppState.activeTrip}/pins/${id}`).remove();
    },
    loadTrip(key) {
        AppState.activeTrip = key;
        const tripName = AppState.trips[key] ? (AppState.trips[key].name || key) : key;
        document.getElementById('activeTripTitle').innerText = tripName.toUpperCase();
        AppState.markers.forEach(m => m.marker.setMap(null));
        AppState.markers = [];
        const pinObj = (AppState.trips[key] && AppState.trips[key].pins) || {};
        Object.values(pinObj).forEach(pin => MapModule.displayMarker(pin));
        this.renderList(); this.renderTrips();
    },
    renderTrips() {
        const el = document.getElementById('tripList'); el.innerHTML = '';
        Object.keys(AppState.trips).forEach(k => {
            if (k === 'app_secret' || k === 'secret') return;
            const div = document.createElement('div'); div.className = `vacation-item ${AppState.activeTrip === k ? 'active-trip' : ''}`;
            div.innerHTML = `<span>${(AppState.trips[k].name || k).toUpperCase()}</span><button class='icon-btn' onclick='event.stopPropagation(); TripManager.deleteTrip("${k}")'>üóëÔ∏è</button>`;
            div.onclick = () => this.loadTrip(k); el.appendChild(div);
        });
    },
    renderList() {
        const el = document.getElementById('groupedList'); el.innerHTML = '';
        if (!AppState.activeTrip || !AppState.trips[AppState.activeTrip] || !AppState.trips[AppState.activeTrip].pins) return;
        const pinArray = Object.values(AppState.trips[AppState.activeTrip].pins);
        ['üî¥ Things to Do', 'üü¢ Places to Stay', 'üü° Places to Eat'].forEach(cat => {
            const items = pinArray.filter(p => p.type === cat); if (!items.length) return;
            el.innerHTML += `<div class='category-header'>${cat}</div>`;
            const colorClass = cat.includes("üî¥") ? "name-todo" : cat.includes("üü¢") ? "name-stay" : "name-eat";
            items.forEach(p => {
                const mU = p.gUrl || `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`;
                const dU = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`;
                el.innerHTML += `
                    <div class='saved-place'>
                        <div class="place-row">
                            <div class='place-info'>
                                <b class="${colorClass}" onclick='MapModule.focusOnPin("${p.id}", ${p.lat}, ${p.lng})'>${p.name}</b>
                                ${p.notes ? `<div class="note-preview" onclick="UIManager.toggleNote(this)">${p.notes}</div>` : ''}
                            </div>
                            <div class="button-group">
                                <button class='icon-btn' onclick='event.stopPropagation(); TripManager.editPin("${p.id}")'>‚úèÔ∏è</button>
                                <button class='icon-btn' style='color:var(--danger)' onclick='event.stopPropagation(); TripManager.deletePin("${p.id}")'>√ó</button>
                            </div>
                        </div>
                        <div class="pin-links">
                            <a href="${mU}" target="_blank">MAP</a>
                            <a href="${dU}" target="_blank">DIRECTIONS</a>
                            ${p.yUrl ? `<a href="${p.yUrl}" target="_blank">YELP</a>` : ''}
                            ${p.link ? `<a href="${p.link}" target="_blank">WEB</a>` : ''}
                        </div>
                    </div>`;
            });
        });
    },
    editPin(id) { 
        const pin = AppState.trips[AppState.activeTrip].pins[id]; if(!pin) return; 
        UIManager.openModal(pin.lat, pin.lng, pin.name, pin.address, pin.id, pin.link, pin.phone, pin.gUrl, pin.yUrl); 
        document.getElementById('pNotes').value = pin.notes || ''; document.getElementById('pType').value = pin.type;
    }
};

const SearchModule = {
    handleSearchSelect(p) {
        this.clearSearchMarkers();
        if (p.geometry.viewport) AppState.map.fitBounds(p.geometry.viewport);
        else { AppState.map.setCenter(p.geometry.location); AppState.map.setZoom(17); }

        if (AppState.placeCache[p.place_id]) {
            this.showLandmarkPopup(AppState.placeCache[p.place_id]);
        } else {
            AppState.service.getDetails({ placeId: p.place_id, fields: ['name', 'formatted_address', 'geometry', 'website', 'formatted_phone_number', 'url'] }, (res, status) => { 
                if (status === 'OK') {
                    AppState.placeCache[p.place_id] = res;
                    this.showLandmarkPopup(res); 
                }
            });
        }
        UIManager.setSheetState(false);
    },
    showLandmarkPopup(place) {
        const lat = place.geometry.location.lat(), lng = place.geometry.location.lng();
        const gMapsUrl = place.url || `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        const dUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        const yelpUrl = `https://www.yelp.com/search?find_desc=${encodeURIComponent(place.name)}&find_loc=${encodeURIComponent(place.formatted_address)}`; 
        AppState.infoWindow.setContent(`<div style="color:#222; min-width:180px; font-family:sans-serif; padding:5px;"><b style="font-size:14px; display:block; margin-bottom:4px;">${place.name}</b><div style="font-size:11px; color:#666; margin-bottom:4px;">üìç ${place.formatted_address || ''}</div><div class="popup-links" style="margin-bottom:10px;"><a href="${gMapsUrl}" target="_blank">MAP</a><a href="${dUrl}" target="_blank">DIRECTIONS</a><a href="${yelpUrl}" target="_blank">YELP</a></div><button onclick="UIManager.openModal(${lat},${lng},'${place.name.replace(/'/g, "\\'")}','${(place.formatted_address || '').replace(/'/g, "\\'")}','','${place.website || ''}','${place.formatted_phone_number || ''}','${gMapsUrl}','${yelpUrl}')" style="width:100%; background:var(--accent); color:white; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer;">PIN THIS PLACE</button></div>`);
        AppState.infoWindow.setPosition(place.geometry.location); AppState.infoWindow.open(AppState.map); UIManager.setSheetState(false);
    },
    clearFullSearch() {
        const sBox = document.getElementById('search-box'); sBox.value = '';
        document.getElementById('clear-search-btn').style.display = 'none';
        this.clearSearchMarkers(); AppState.infoWindow.close();
    },
    clearSearchMarkers() { AppState.searchMarkers.forEach(m => m.setMap(null)); AppState.searchMarkers = []; }
};

const MapModule = {
    displayMarker(pin) {
        let pinColor = pin.type.includes("üî¥") ? "#e74c3c" : pin.type.includes("üü¢") ? "#27ae60" : "#f1c40f";
        const marker = new google.maps.Marker({ map: AppState.map, position: {lat: parseFloat(pin.lat), lng: parseFloat(pin.lng)}, icon: { path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z", fillColor: pinColor, fillOpacity: 1, strokeColor: "#ffffff", strokeWeight: 2, scale: 1.5, anchor: new google.maps.Point(12, 22) } });
        marker.addListener('click', () => this.openPopup(pin, marker));
        AppState.markers.push({id: pin.id, marker});
    },
    openPopup(pin, marker) {
        const mU = pin.gUrl || `https://www.google.com/maps/search/?api=1&query=${pin.lat},${pin.lng}`;
        const dU = `https://www.google.com/maps/dir/?api=1&destination=${pin.lat},${pin.lng}`;
        const yU = pin.yUrl || '';
        AppState.infoWindow.setContent(`<div style="color:#222; min-width:180px; font-family:sans-serif;"><b>${pin.name}</b><div style="font-size:11px; color:#666; margin:4px 0;">${pin.address || ''}</div><div class="popup-links"><a href="${mU}" target="_blank">MAP</a><a href="${dU}" target="_blank">DIRECTIONS</a>${yU ? `<a href="${yU}" target="_blank">YELP</a>` : ''}</div></div>`);
        AppState.infoWindow.open(AppState.map, marker); UIManager.setSheetState(false);
    },
    focusOnPin(id, lat, lng) {
        AppState.map.setCenter({lat, lng}); AppState.map.setZoom(17);
        const mObj = AppState.markers.find(m => m.id == id);
        if (mObj) this.openPopup(AppState.trips[AppState.activeTrip].pins[id], mObj.marker);
    }
};

function initApp() {
    AppState.map = new google.maps.Map(document.getElementById('map'), { center:{lat:39.8,lng:-98.5}, zoom:4, mapTypeId:'hybrid', clickableIcons:true, mapTypeControl:false, streetViewControl:false, tilt: 0 });
    AppState.service = new google.maps.places.PlacesService(AppState.map);
    AppState.infoWindow = new google.maps.InfoWindow();
    auth.signInAnonymously().catch(err => alert("Auth Error: " + err.message));
    const localBackup = localStorage.getItem('vmapper_pins_backup');
    if (localBackup) { AppState.trips = JSON.parse(localBackup); TripManager.renderTrips(); }
    const sBox = document.getElementById('search-box');
    const clearBtn = document.getElementById('clear-search-btn');
    AppState.autocomplete = new google.maps.places.Autocomplete(sBox);
    AppState.autocomplete.bindTo('bounds', AppState.map);
    AppState.autocomplete.addListener('place_changed', () => { 
        const p = AppState.autocomplete.getPlace(); if (p.geometry) { clearBtn.style.display = 'flex'; SearchModule.handleSearchSelect(p); }
    });
    sBox.addEventListener('input', () => { clearBtn.style.display = sBox.value ? 'flex' : 'none'; });
    sBox.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && sBox.value) {
            clearBtn.style.display = 'flex';
            AppState.service.textSearch({ query: sBox.value, bounds: AppState.map.getBounds() }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    SearchModule.clearSearchMarkers();
                    results.forEach((res, i) => {
                        const marker = new google.maps.Marker({ map: AppState.map, position: res.geometry.location, icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 5, fillColor: "#4a90e2", fillOpacity: 0.9, strokeColor: "#ffffff", strokeWeight: 2 } });
                        marker.addListener('click', () => {
                            if (AppState.placeCache[res.place_id]) SearchModule.showLandmarkPopup(AppState.placeCache[res.place_id]);
                            else AppState.service.getDetails({ placeId: res.place_id, fields: ['name', 'formatted_address', 'geometry', 'website', 'formatted_phone_number', 'url'] }, (p, s) => { if (s === 'OK') { AppState.placeCache[res.place_id] = p; SearchModule.showLandmarkPopup(p); } });
                        });
                        AppState.searchMarkers.push(marker); if (i === 0) AppState.map.panTo(res.geometry.location);
                    });
                    UIManager.setSheetState(false);
                }
            });
        }
    });
    AppState.map.addListener('click', (e) => {
        if (e.placeId) {
            e.stop();
            if (AppState.placeCache[e.placeId]) SearchModule.showLandmarkPopup(AppState.placeCache[e.placeId]);
            else AppState.service.getDetails({ placeId: e.placeId, fields: ['name', 'formatted_address', 'geometry', 'website', 'formatted_phone_number', 'url'] }, (p, s) => { if (s === 'OK') { AppState.placeCache[e.placeId] = p; SearchModule.showLandmarkPopup(p); } });
        } else { UIManager.openModal(e.latLng.lat(), e.latLng.lng()); }
    });
    db.ref('trips').on('value', (s) => { 
        AppState.trips = s.val() || {}; 
        localStorage.setItem('vmapper_pins_backup', JSON.stringify(AppState.trips));
        TripManager.renderTrips(); if (AppState.activeTrip) TripManager.loadTrip(AppState.activeTrip); 
    });
    UIManager.initGestures();
}
window.onload = initApp;
</script>
</body>
</html>
